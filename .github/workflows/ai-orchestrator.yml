name: Trading Orchestrator (IST)

on:
  schedule:
    # Universe update at 08:45 IST = 03:15 UTC (Mon‚ÄìFri)
    - cron: '15 3 * * 1-5'
    # Market scans every 15 minutes from 09:15‚Äì14:55 IST (UTC conversions below)
    # 09:15 IST = 03:45 UTC
    - cron: '45 3 * * 1-5'
    # 09:30‚Äì13:45 IST = 04:00‚Äì08:45 UTC, every :00,:15,:30,:45
    - cron: '0,15,30,45 4-8 * * 1-5'
    # 14:00‚Äì14:45 IST ‚âà 08:30‚Äì09:15 UTC in quarter steps
    - cron: '0,15,30,45 9 * * 1-5'
    # Optional final tick near 14:55 IST = 09:25 UTC
    - cron: '25 9 * * 1-5'
  workflow_dispatch:

jobs:
  orchestrate:
    runs-on: ubuntu-latest
    steps:
      - name: Decide and call bot endpoints
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${{ secrets.BOT_URL }}" ]; then
            echo "BOT_URL secret is missing"; exit 1
          fi

          # India time
          IST_HH=$(TZ='Asia/Kolkata' date +%H)
          IST_MM=$(TZ='Asia/Kolkata' date +%M)
          IST_HHMM=$(TZ='Asia/Kolkata' date +%H:%M)
          IST_DOW=$(TZ='Asia/Kolkata' date +%u)  # 1=Mon ... 7=Sun

          echo "IST now: $IST_HH:$IST_MM (DoW=$IST_DOW)"

          # Skip weekends (extra safety)
          if [ "$IST_DOW" -gt 5 ]; then
            echo "Weekend, skipping."
            exit 0
          fi

          # Market window: 09:15‚Äì15:15 IST
          in_market_window=false
          if [ "$IST_HH" -ge 9 ] && [ "$IST_HH" -le 15 ]; then
            if { [ "$IST_HH" -gt 9 ] || { [ "$IST_HH" -eq 9 ] && [ "$IST_MM" -ge 15 ]; }; } \
               && { [ "$IST_HH" -lt 15 ] || { [ "$IST_HH" -eq 15 ] && [ "$IST_MM" -lt 15 ]; }; }; then
              in_market_window=true
            fi
          fi

          ACTIONS_TO_TAKE=""

          # 1) Universe update exactly at 08:45 IST
          if [ "$IST_HHMM" = "08:45" ]; then
            echo "üåÖ Universe update (08:45 IST)"
            ACTIONS_TO_TAKE="$ACTIONS_TO_TAKE,universe-update"
          fi

          # 2) Continuous scans every 15 minutes (no lunch break)
          if [ "$in_market_window" = true ]; then
            if [ "$IST_MM" -eq 0 ] || [ "$IST_MM" -eq 15 ] || [ "$IST_MM" -eq 30 ] || [ "$IST_MM" -eq 45 ] || [ "$IST_MM" -eq 55 ]; then
              echo "üîç Regular scan time"
              ACTIONS_TO_TAKE="$ACTIONS_TO_TAKE,scan-opportunities"
            fi

            # 3) Always monitor during market window
            ACTIONS_TO_TAKE="$ACTIONS_TO_TAKE,monitor-positions"
          fi

          # Always do a health check
          ACTIONS_TO_TAKE="$ACTIONS_TO_TAKE,health-check"

          # Normalize list (trim, dedupe)
          IFS=',' read -ra RAW <<< "$ACTIONS_TO_TAKE"
          declare -A seen=()
          ACTIONS=()
          for a in "${RAW[@]}"; do
            a="$(echo "$a" | xargs)"
            if [ -n "$a" ] && [ -z "${seen[$a]+x}" ]; then
              ACTIONS+=("$a")
              seen[$a]=1
            fi
          done

          echo "Planned actions: ${ACTIONS[*]}"

          for action in "${ACTIONS[@]}"; do
            echo "üöÄ Executing: $action"
            case "$action" in
              universe-update)
                curl -sS -X POST "${{ secrets.BOT_URL }}/cron/universe-update" || true
                ;;
              scan-opportunities)
                curl -sS -X POST "${{ secrets.BOT_URL }}/cron/scan-opportunities" || true
                ;;
              monitor-positions)
                curl -sS -X POST "${{ secrets.BOT_URL }}/cron/monitor-positions" || true
                ;;
              health-check)
                curl -sS "${{ secrets.BOT_URL }}/cron/health-check" || true
                ;;
              *)
                echo "Unknown action: $action"
                ;;
            esac
            sleep 2
          done

          echo "‚úÖ Orchestration cycle complete"
