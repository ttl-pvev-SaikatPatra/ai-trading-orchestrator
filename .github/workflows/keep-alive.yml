# .github/workflows/keep-alive.yml
name: Keep Alive (Trading Day)

on:
  schedule:
    # 07:30‚Äì16:30 IST ‚âà 02:00‚Äì11:00 UTC, every 8 minutes on weekdays
    - cron: '*/8 2-11 * * 1-5'
  workflow_dispatch:

jobs:
  keep:
    runs-on: ubuntu-latest
    steps:
      - name: Ping health with warm-up and backoff
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${{ secrets.BOT_URL }}" ]; then
            echo "BOT_URL secret missing"; exit 1
          fi
          echo "üè• Keep-alive ping"
          curl_retry() {
            local url="$1"
            local attempts=4
            local delay=3
            for ((i=1;i<=attempts;i++)); do
              # Warmup HEAD (short) to trigger cold start
              curl -sS -I --connect-timeout 10 --max-time 12 "$url" || true
              # Main GET with generous timeout
              if curl -sS     --connect-timeout 12 --max-time 75 --fail "$url"; then
                echo "‚úÖ Warmed: $url"
                return 0
              fi
              echo "WARN: attempt $i failed; retry in ${delay}s" >&2
              sleep "$delay"
              delay=$((delay*2))
            done
            echo "WARN: keep-alive failed after retries: $url" >&2
            return 0
          }
          curl_retry "${{ secrets.BOT_URL }}/health"
          echo "‚úÖ Done"
